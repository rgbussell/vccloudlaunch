#!/bin/sh

#VC_cloudRun: Start a vc processing job in the cloud
#example: VC_cloudRun rbussell ~/data/compliance/kb_study/180707_PupAlz/PupAlz_119/119_180612 
# NB: specify the data directory all the way to the id_dir

sptMsg="`basename $0`:"

throwInputArgError() {
  echo ERROR: Bad or not enough input arguments. EXITING
  echo Try it like this: VC_cloudRun youruserid ~/your/study/directory
  exit
}

checkInputArgs() {
if [ $# -lt 2 ]; then
  throwInputArgError()
  exit
else
  userid=$1
  localRawDir=$2
  if [ "$#" -gt 2 ];then
    mode=$3
  fi
fi
echo userid is $userid
echo datadir is $localRawDir
}
#Set default mode and check for input mode
#Only runcloud implemented for now.
#Add test later
mode=runcloud
remoteProcDir="~/data/vcprocRemote/"
remoteScript="./VC_remoteScript"
procScript="~/bin/vc/VC_runProc.bash"

serverHostname="52.53.94.192"
descriptorFn=../descriptors/instanceIDs
remoteHost=$serverHostname

checkIntervalSec=2
nChecks=90

UP=1
DOWN=0

UNKNOWN=99
STOPPING=0
RUNNING=1
STOPPED=2
PENDING=3
SHUTTINGDOWN=4

readInstanceDescriptor() {
# get the instance ID
region=`cat $descriptorFn | grep "^vcprod " | awk '{print $3}'`
instanceID=`cat $descriptorFn | grep "^vcprod " | awk '{print $2}'`
echo found instance instanceID $instanceID in region $region
}

printInstanceStatus() {
aws ec2 describe-instances --instance-ids $instanceID --region $region --output text > /tmp/stat.$$
}

getInstanceState() {
printInstanceStatus
state=$UNKNOWN
grep STATE /tmp/stat.$$ | grep -q running  && state=$RUNNING
grep STATE /tmp/stat.$$ | grep -q stopped  && state=$STOPPED
grep STATE /tmp/stat.$$ | grep -q stopping && state=$STOPPING
grep STATE /tmp/stat.$$ | grep -q pending  && state=$PENDING
echo $state
}

cleanupAndExit() {
#rm -f /tmp/stat.$$
echo $sptMsg exiting
}

startInstance() {
aws ec2 start-instances --instance-ids $instanceID --region $region
}

stopInstance() {
aws ec2 stop-instances --instance-ids $instanceID --region $region
}

waitForNetwork() {
  echo checking for network.
  cnt=0
  netState=down
  drawBar $nChecks;echo
  while [ "$cnt" -lt "$nChecks" ];do
    echo -n .
    if checkRemoteSSH | grep -q down; then
      netSstate=down
      sleep $checkIntervalSec
    else
      cnt=$nChecks
    fi
    netState=up
    cnt=$(( $cnt+1 ))
  done

  #do one last check on network
  tmp="$(checkRemoteSSH)"
  echo checkRemoteSSH returns `checkRemoteSSH`
  echo $checkRemoteSSH | grep -q down && echo ERROR! Network check timed out without success.; exit
  echo $checkRemoteSSH | grep -q up && echo returning from network check. Network is up
}

waitForInstanceToStart() {
echo waiting for instance to start.
cnt=0
drawBar $nChecks;echo
while [ "$cnt" -lt "$nChecks" ];do
echo -n .
sleep $checkIntervalSec
if [ `getInstanceState` -eq $RUNNING ];then
  cnt=$nChecks
  state=$RUNNING
  echo instance is now running. breaking out of starting hold.
fi
cnt=$(( $cnt+1 ))
done
}

drawBar() { 
nDots=$1
cnt=0
while [ "$cnt" -lt "$nDots" ];do
  echo -n .
  cnt=$(( $cnt+1 ))
done
echo -n "|"
}

waitForInstanceToStop() {
if [ `getInstanceState` -eq $STOPPED ];then
  echo instance is stopped
else
 echo waiting for instance to stop.
 drawBar $nChecks; echo
 cnt=0
 while [ "$cnt" -lt "$nChecks" ];do
 echo -n .
 sleep $checkIntervalSec
 if [ `getInstanceState` -eq $STOPPED ];then
   cnt=$nChecks
   echo instance is now stopped. breaking out of stopping hold.
   state=$STOPPED
 fi
 cnt=$(( $cnt+1 ))
 done
fi
}

closeSession() {
if [ `getInstanceState` -eq $RUNNING ];then
  stopInstance
  waitForInstanceToStop
fi
}

openSession() {
  if [ `getInstanceState` -eq $STOPPED ]; then
    waitForInstanceToStop
    startInstance
    waitForInstanceToStart
    waitForNetwork

    checkRemoteSSH | grep -q down && echo network is down. This could be a problem!
    checkRemoteSSH | grep -q up && echo network is up

  fi
}


sayHello() {
echo; echo
echo ------------------vc cloud launch-------------------------
echo This code for processing vascular compliance data.
echo Run it as follows: VC_cloudRun username studydir
echo
echo For example, if your user name on the processing server is \"seinfeld\" and
echo your data is in the directory called \"~/data/sarcasm_study\"
echo please launch the code with this command from a shell: 
echo
echo VC_cloudRun seinfeld ~/data/seinfeld_sarcasm_study
echo 
echo Data should be in a standard format as generated by vc preprocessing.
echo
echo For help or bug reports, contact: Robert Bussell, rbussell@ucsd.edu.
echo -----------------------------------------------------------
echo;echo
}

#getSubDir() {
  #echo $sptMsg looking for subject_info.txt in $localRawDir
#  id=`grep "^id " $localRawDir"/subject_info.txt" | awk '{print $2}'`
#  dateStr=`grep "^date " $localRawDir"/subject_info.txt" | awk '{print $2}'`
#  id_dir=$id"_"$dateStr
#}

transferData() {
echo $sptMsg transfer files files is $localRawDir/VCFilesToTransfer.txt
remoteProcDir=$remoteProcDir/`basename $localRawDir`_vccloud
rsyncCmd="rsync -avxP --files-from=$localRawDir/VCFilesToTransfer.txt $localRawDir $userid@$remoteHost:$remoteProcDir"
echo $rsyncCmd
$rsyncCmd
}

checkRemoteSSH() {
sshState=$DOWN
nc -zv $serverHostname 22 2>&1 | grep -q succeeded && sshState=$UP 
if [ $sshState -eq $UP ]
then
  echo port 22 is up
fi
if [ $sshState -eq $DOWN ]
then
  echo port 22 is down
fi
}

readM0() {
  M0=`awk '{print}' $localRawDir/reg/M0_blood.txt`
}

readPP() {
  pp=`grep ^pp $subjectInfoFile | awk '{print $2}'`
}

makeLaunchScript() {
  readM0
  readPP
  echo localRawDir is $localRawDir
  echo remoteProcDir is $remoteProcDir
  echo M0 is $M0
  echo pp is $pp
  launchCmd=/home/rbussell/bin/vc/VC_runProc.bash
  launchCmd="$launchCmd $remoteProcDir $localRawDir $M0 $pp remoteproc"
  echo launchCmd is $launchCmd
  echo "#!/bin/bash" > /tmp/launchSpt
  echo cd $remoteProcDir
  echo "$launchCmd" >> /tmp/launchSpt
}

startRemote() {
  echo startRemote called
  makeLaunchScript
  echo -------------
  echo $sptMsg generated this script for ssh call
  more /tmp/launchSpt
  echo -------------
  #ssh -X $userid@$remoteHost "echo $launchCmd > $remoteProcDir/launchCmd; /bin/bash ./launchCmd"
  #ssh -X $userid@$remoteHost 'cd $remoteProcDir; /bin/bash -s' < /tmp/launchSpt
  ssh -X $userid@$remoteHost "$launchCmd"
}


checkRequiredFiles() {
  onFail() {
    echo $sm ERROR: 
    echo ====================  ERROR  ========================= 
    echo !!!! Some required input files not found!!!!
    VC_checkRequiredFiles $localRawDir
    echo ===================  EXITING  ======================== 
    exit
  }
  tmp="$(VC_checkRequiredFiles $localRawDir)"
  echo $tmp | grep -q "Not found" && onFail
}
#--------MAIN---------
#getSubDir

checkInputArgs "$@"
echo $sptMsg localRawDir is $localRawDir
subjectInfoFile=$localRawDir"/subject_info.txt"
echo $sm will look for subject info in file $subjectInfoFile
checkRequiredFiles $localRawDir

#sayHello

readInstanceDescriptor

openSession

transferData

#makeLaunchScript

#startRemote

cleanupAndExit
